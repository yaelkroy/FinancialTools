
                                                            Amount DECIMAL(10,2), 
                                                            RunDate DATE, 
                                                            TIMESTAMP TIMESTAMP, 
                                                            VoucherType VARCHAR(16), 
                                                            VoucherStatus VARCHAR(16), 
                                                            VoucherStatusDate DATE, 
                                                            VoucherStatusTime TIME, 
                                                            VoucherStatusUser VARCHAR(16), 
                                                            VoucherStatusDesc VARCHAR(255), 
                                                            VoucherStatusReason VARCHAR(255), 
                                                            VoucherStatusComment VARCHAR(255), 
                                                            VoucherStatusReasonCd VARCHAR(16), 
                                                            VoucherStatusUserCd VARCHAR(16), 
                                                            VoucherStatusTypeCd VARCHAR(16), 
                                                            VoucherStatusTypeDesc VARCHAR(255), 
                                                            VoucherStatusType VARCHAR(16), 
                                                            VoucherStatusTypeDescCd VARCHAR(16), 
                                                            VoucherStatusTypeDescCd2 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd3 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd4 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd5 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd6 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd7 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd8 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd9 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd10 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd11 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd12 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd13 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd14 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd15 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd16 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd17 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd18 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd19 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd20 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd21 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd22 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd23 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd24 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd25 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd26 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd27 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd28 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd29 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd30 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd31 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd32 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd33 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd34 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd35 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd36 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd37 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd38 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd39 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd40 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd41 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd42 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd43 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd44 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd45 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd46 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd47 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd48 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd49 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd50 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd51 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd52 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd53 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd54 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd55 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd56 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd57 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd58 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd59 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd60 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd61 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd62 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd63 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd64 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd65 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd66 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd67 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd68 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd69 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd70 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd71 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd72 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd73 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd74 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd75 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd76 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd77 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd78 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd79 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd80 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd81 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd82 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd83 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd84 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd85 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd86 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd87 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd88 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd89 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd90 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd91 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd92 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd93 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd94 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd95 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd96 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd97 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd98 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd99 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd100 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd101 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd102 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd103 VARCHAR(16), 
                                                            VoucherStatusTypeDescCd104 VARCHAR(16),
                                                            pytmon DATE,
                                                            vouchercd VARCHAR(16),
                                                            kids_id VARCHAR(16),
                                                            effdate DATE,
                                                            facets_id_min VARCHAR(16),
                                                            facets_id_O VARCHAR(16),
                                                            HOHid_min VARCHAR(16),
                                                            HOHid_O VARCHAR(16),
                                                            PytCat_min VARCHAR(16),
                                                            PytCat_O VARCHAR(16),
                                                            PremPayment MONEY,
                                                            OldPrem MONEY,
                                                            AmtDuePlan MONEY,
                                                            AdjEffective DATE,
                                                            EffDate Date,
                                                            RunDt Timestamp,
                                                            RunDate Timestamp,
                                                            Comments VARCHAR(255),
                                                            DupFound BOOL,
                                                            Category VARCHAR(255),
                                                            TimeStamp Timestamp,
                                                            voucher_file_name VARCHAR(255));
I have sanitized the code by removing sensitive information:

```
AmtDue MONEY,
RcdNo VARCHAR(16),
RunDate TIMESTAMP,
TimeStamp TIMESTAMP
);

CREATE TABLE sandbox.financialtools_chprecon_tmp_Data_CurMon " +
("Month Of Service" DATE, "Paid Member Count" INTEGER, "Capitation Collected" MONEY, "Average PMPM" MONEY, "Total Plan Membership" INTEGER, "Unpaid Membership" INTEGER, "Estimated Unpaid Capitation" MONEY, "Collection Ratio" FLOAT8 @);
CREATE TABLE sandbox.financialtools_chprecon_tmpRpt_CurMon ( ReportList VARCHAR(255), MOS date, Seq Integer, Entry TEXT, Timestamp TIMESTAMP );
INSERT INTO sandbox.financialtools_chprecon_tmpRpt_CurMon (REPORTLIST, Seq) VALUES ('Paid Member Months', 1);
INSERT INTO sandbox.financialtools_chprecon_tmpRpt_CurMon (REPORTLIST, Seq) VALUES ('Total Paid', 2);
INSERT INTO sandbox.financialtools_chprecon_tmpRpt_CurMon (REPORTLIST, Seq) VALUES ('Average PMPM', 3);
INSERT INTO sandbox.financialtools_chprecon_tmpRpt_CurMon (REPORTLIST, Seq) VALUES ('FACETS Active Member Months', 4);
INSERT I
```public void InsertDataIntoReportTable()
{
    try
    {
        string query = "INSERT INTO sandbox.financialtools_chprecon_tmpRpt_CurMon (REPORTLIST, Seq) VALUES ('Unpaid Member Months', 5);" +
            "INSERT INTO sandbox.financialtools_chprecon_tmpRpt_CurMon (REPORTLIST, Seq) VALUES ('Unpaid Estimated Total', 6);" +
            "INSERT INTO sandbox.financialtools_chprecon_tmpRpt_CurMon (REPORTLIST, Seq) VALUES ('Collection ratio', 7);" +
            "CREATE TABLE sandbox.financialtools_chprecon_tmp_MOS_List" +
            "( \"Month Of Service\" DATE, PytMon DATE, AgeMon INTEGER, Grp INTEGER, Timestamp timestamp);";

        connection.Open();
        NpgsqlCommand command = new NpgsqlCommand(query, connection)
        {
            CommandTimeout = 0
        };
        int error = command.ExecuteNonQuery();

        connection.Close();
    }
    catch (NpgsqlException e)
    {
        if (connection != null)
            connection.Close();
        throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
    }
    finally
    {
        if (connection != null)
            connection.Close();
    }
}

public string GetFileName(DateTime date)
{
    NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);
    string result = "";

    try
    {
        string query = @"SELECT DISTINCT voucher_file_name
                        from raw.chp_voucher_detail pmt
                        WHERE pmt.voucher_mth_cd = '" + date.Month.ToString() + "' AND pmt.voucher_file_name = (SELECT MAX(voucher_file_name) FROM raw.chp_voucher_detail where voucher_file_name LIKE '%\\\\_" + date.Month.ToString("00") + "\\\\_" + date.Year.ToString() + "\\\\_%');";
    }
    catch (NpgsqlException e)
    {
        if (connection != null)
            connection.Close();
        throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
    }
    finally
    {
        if (connection != null)
            connection.Close();
    }
}                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };

                NpgsqlDataReader thisReader = command.ExecuteReader();
                query = "";
                if (thisReader.Read())
                {
                    result = thisReader.GetValue(0).ToString();
                }
                connection.Close();
                connection.Open();
                command = new NpgsqlCommand(query, connection);
                command.ExecuteNonQuery();
                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

            return result;
        }
        public void CHPReconCleanInHistoryIfExists(DateTime date)
        {

            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);


            try
            {






                string query = "";

                query += "DELETE FROM sandbox.financialtools_chprecon_list_unpaid_summary where voucher_file_name LIKE '%\\\\_" + date.Month.ToString("00") + "\\\\_" + date.Year.ToString() + "\\\\_%';";
                query += "DELETE FROM sandbox.financialtools_chprecon_historic_voucher_detail where voucher_file_name LIKE '%\\\\_" + date.Month.ToString("00") + "\\\\_" + date.Year.ToString() + "\\\\_%';";
                query += "DELETE FROM sandbox.financialtools_chprecon_historic_voucher_dup where voucher_file_name LIKE '%\\\\_" + date.Month.ToString("00") + "\\\\_" + date.Year.ToString() + "\\\\_%';";
                query += "DELETE FROM Sandbox.FinTEGER	,
                            gendercd	VARCHAR(16)	,
                            dob	DATE	,
                            age	INTEGER	,
                            inc	INTEGER	,
                            amt	INTEGER	,
                            amttypecd	VARCHAR(16)	,
                            pymttypecd	VARCHAR(16)	,
                            pymtcd	VARCHAR(16)	,
                            pymtcd_desc	VARCHAR(16)	,
                            pymtcd_desc1	VARCHAR(16)	,
                            pymtcd_desc2	VARCHAR(16)	,
                            pymtcd_desc3	VARCHAR(16)	,
                            pymtcd_desc4	VARCHAR(16)	,
                            pymtcd_desc5	VARCHAR(16)	,
                            pymtcd_desc6	VARCHAR(16)	,
                            pymtcd_desc7	VARCHAR(16)	,
                            pymtcd_desc8	VARCHAR(16)	,
                            pymtcd_desc9	VARCHAR(16)	,
                            pymtcd_desc10	VARCHAR(16)	,
                            pymtcd_desc11	VARCHAR(16)	,
                            pymtcd_desc12	VARCHAR(16)	,
                            pymtcd_desc13	VARCHAR(16)	,
                            pymtcd_desc14	VARCHAR(16)	,
                            pymtcd_desc15	VARCHAR(16)	,
                            pymtcd_desc16	VARCHAR(16)	,
                            pymtcd_desc17	VARCHAR(16)	,
                            pymtcd_desc18	VARCHAR(16)	,
                            pymtcd_desc19	VARCHAR(16)	,
                            pymtcd_desc20	VARCHAR(16)	,
                            pymtcd_desc21	VARCHAR(16)	,
                            pymtcd_desc22	VARCHAR(16)	,
                            pymtcd_desc23	VARCHAR(16)	,
                            pymtcd_desc24	VARCHAR(16)	,
                            pymtcd_desc25	VARCHAR(16)	,
                            pymtcd_desc26	VARCHAR(16)	,
                            pymtcd_desc27	VARCHAR(16)	,
                            pymtcd_desc28	VARCHAR(16)	,
                            pymtcd_desc29	VARCHAR(16)	,
                            pymtcd_desc30	VARCHAR(16)	,
                            pymtcd_desc31	VARCHAR(16)	,
                            pymtcd_desc32	VARCHAR(16)	,
                            pymtcd_desc33	VARCHAR(16)	,
                            pymtcd_desc34	VARCHAR(16)	,
                            pymtcd_desc35	VARCHAR(16)	,
                            pymtcd_desc36	VARCHAR(16)	,
                            pymtcd_desc37	VARCHAR(16)	,
                            pymtcd_desc38	VARCHAR(16)	,
                            pymtcd_desc39	VARCHAR(16)	,
                            pymtcd_desc40	VARCHAR(16)	,
                            pymtcd_desc41	VARCHAR(16)	,
                            pymtcd_desc42	VARCHAR(16)	,
                            pymtcd_desc43	VARCHAR(16)	,
                            pymtcd_desc44	VARCHAR(16)	,
                            pymtcd_desc45	VARCHAR(16)	,
                            pymtcd_desc46	VARCHAR(16)	,
                            pymtcd_desc47	VARCHAR(16)	,
                            pymtcd_desc48	VARCHAR(16)	,
                            pymtcd_desc49	VARCHAR(16)	,
                            pymtcd_desc50	VARCHAR(16)	,
                            pymtcd_desc51	VARCHAR(16)	,
                            pymtcd_desc52	VARCHAR(16)	,
                            pymtcd_desc53	VARCHAR(16)	,
                            pymtcd_desc54	VARCHAR(16)	,
                            pymtcd_desc55	VARCHAR(16)	,
                            pymtcd_desc56	VARCHAR(16)	,
                            pymtcd_desc57	VARCHAR(16)	,
                            pymtcd_desc58	VARCHAR(16)	,
                            pymtcd_desc59	VARCHAR(16)	,
                            pymtcd_desc60	VARCHAR(16)	,
                            pymtcd_desc61	VARCHAR(16)	,
                            pymtcd_desc62	VARCHAR(16)	,
                            pymtcd_desc63	VARCHAR(16)	,
                            pymtcd_desc64	VARCHAR(16)	,
                            pymtcd_desc65	VARCHAR(16)	,
                            pymtcd_desc66	VARCHAR(16)	,
                            pymtcd_desc67	VARCHAR(16)	,
                            pymtcd_desc68	VARCHAR(16)	,
                            pymtcd_desc69	VARCHAR(16)	,
                            pymtcd_desc70	VARCHAR(16)	,
                            pymtcd_desc71	VARCHAR(16)	,
                            pymtcd_desc72	VARCHAR(16)	,
                            pymtcd_desc73	VARCHAR(16)	,
                            pymtcd_desc74	VARCHAR(16)	,
                            pymtcd_desc75	VARCHAR(16)	,
                            pymtcd_desc76	VARCHAR(16)	,
                            pymtcd_desc77	VARCHAR(16)	,
                            pymtcd_desc78	VARCHAR(16)	,
                            pymtcd_desc79	VARCHAR(16)	,
                            pymtcd_desc80	VARCHAR(16)	,
                            pymtcd_desc81	VARCHAR(16)	,
                            pymtcd_desc82	VARCHAR(16)	,
                            pymtcd_desc83	VARCHAR(16)	,
                            pymtcd_desc84	VARCHAR(16)	,
                            pymtcd_desc85	VARCHAR(16)	,
                            pymtcd_desc86	VARCHAR(16)	,
                            pymtcd_desc87	VARCHAR(16)	,
                            pymtcd_desc88	VARCHAR(16)	,
                            pymtcd_desc89	VARCHAR(16)	,
                            pymtcd_desc90	VARCHAR(16)	,
                            pymtcd_desc91	VARCHAR(16)	,
                            pymtcd_desc92	VARCHAR(16)	,
                            pymtcd_desc93	VARCHAR(16)	,
                            pymtcd_desc94	VARCHAR(16)	,
                            pymtcd_desc95	VARCHAR(16)	,
                            pymtcd_desc96	VARCHAR(16)	,
                            pymtcd_desc97	VARCHAR(16)	,
                            pymtcd_desc98	VARCHAR(16)	,
                            pymtcd_desc99	VARCHAR(16)	,
                            pymtcd_desc100	VARCHAR(16)	,
                            pymtcd_desc101	VARCHAR(16)	,
                            pymtcd_desc102	VARCHAR(16)	,
                            pymtcd_desc103	VARCHAR(16)	,
                            pymtcd_desc104	VARCHAR(16)	,
                            pymtcd_desc105	VARCHAR(16)	,
                            pymtcd_desc106	VARCHAR(16)	,
                            pymtcd_desc107	VARCHAR(16)	,
                            pymtcd_desc108	VARCHAR(16)	,
                            pymtcd_desc109	VARCHAR(16)	,
TEGER, 	
                                        pmt.chp_income_nbr AS CHPB, 	
                                        pmt.payment_category_cd AS PaymentCat, 	
                                        pmt.premium_payment_amt AS PremPayment, 	
                                        pmt.old_premium_amt AS OldPrem, 	
                                        pmt.amt_due_pln AS AmtDuePlan, 	
                                        pmt.adj_effective_dt AS AdjEffective, 	
                                        pmt.eff_dt AS EffDate, 	
                                        pmt.run_dt AS RunDt, 	
                                        pmt.run_date AS RunDate, 	
                                        pmt.record_no AS RecordNo, 	
                                        pmt.facets_id AS FacetsID, 	
                                        pmt.category AS Category, 	
                                        pmt.comments AS Comments, 	
                                        pmt.dup_found AS DupFound, 	
                                        pmt.timestamp AS TimeStamp, 	
                                        pmt.voucher_file_name AS VoucherFileName
                                        FROM Sandbox.FinancialTools_CHPRecon_Voucher pmt
                                        WHERE pmt.eff_dt = '" + new DateTime(date.Year, date.Month, 1).ToString() + @"';";
                        command = new NpgsqlCommand(query, connection);
                        error = command.ExecuteNonQuery();br AS CHPB, 	
                                        pmt.voucher_pymt_cat_cd AS PaymentCat, 	
                                        pmt.voucher_curr_prem_pymt_amt AS PremPayment, 	
                                        pmt.voucher_prev_prem_pymt_amt AS OldPrem, 	
                                        pmt.voucher_amt AS AmtDuePlan, 	
                                        pmt.voucher_adj_eff_dt AS AdjEffective,
                                        CASE
                                            when pmt.voucher_adj_eff_dt > '01/01/1900' then date_trunc('month',pmt.voucher_adj_eff_dt)
                                            when pmt.voucher_adj_eff_dt < '01/01/1900' and pmt.voucher_pymt_cd='C' then date_trunc('month',pmt.voucher_run_dt) 
                                        END
                                                AS EffDate,
                                        date_trunc('month',pmt.voucher_run_dt)  AS RunDt, 
                                        date_trunc('month',pmt.voucher_run_dt)  AS RunDate,
                                        member.meme_record_no AS RecordNo, 
                                        member.sbsb_id AS Facets_ID,
                                        ''              AS Category,
                                        ''              AS Comments,
                                        false           AS DupFound,'" +
                         new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).ToString() + @"' AS TimeStamp,
                                        pmt.voucher_file_name
                                        from raw.chp_voucher_detail pmt
                                        LEFT JOIN ods_facets.fid_kids_master  member 
                                        ON pmt.enrollee_id = member.planenrolleeidentifier
                                        WHERE pmt.voucher_mth_cd = '" + date.Month.ToString() + "' AND pmt.voucher_file_name = (SELECT MAX(voucher_fil                }
                public void CHPReconAppendUnpaidSummary(DateTime date)
                {



                    NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);
                    DateTime Date = new DateTime(date.Year, date.Month, 1);
                    string strDate = Date.ToString("MM/dd/yyyy");


                    try
                    {
                        string query = Import.getCHPReconGetCHPPremExcelFileQuery(Date);

                        connection.Open();
                        NpgsqlCommand command = new NpgsqlCommand(query, connection)
                        {
                            CommandTimeout = 0
                        };
                        int error = command.ExecuteNonQuery();

                        connection.Close();

                    }
                    catch (NpgsqlException e)
                    {
                        if (connection != null)
                            connection.Close();
                        throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

                    }
                    finally
                    {
                        if (connection != null)
                            connection.Close();
                    }

                }{
                    finally
                    {
                        if (connection != null)
                            connection.Close();
                    }

                }
                public void CHPReconGroupingDeduping()
                {



                    NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);



                    try
                    {
                        string query = @"UPDATE [Table_Name] SET Category = 'Retro Add' WHERE ((AmtDuePlan=PremPayment) AND (VoucherCd='A') AND (Category = ''));";

                        connection.Open();
                        NpgsqlCommand command = new NpgsqlCommand(query, connection)
                        {
                            CommandTimeout = 0
                        };
                        int error = command.ExecuteNonQuery();
                        query = @"UPDATE [Table_Name] SET Category='Retro Term' WHERE ((AmtDuePlan=OldPrem*-1) AND (VoucherCd='A') AND (Category =''));";


                        command = new NpgsqlCommand(query, connection)
                        {
                            CommandTimeout = 0
                        };
                        error = command.ExecuteNonQuery();
                        query = @"UPDATE [Table_Name] SET Category='Rate Adj' WHERE ((VoucherCd='A') AND (Category = ''));";


                        command = new NpgsqlCommand(query, connection)
                        {
                            CommandTimeout = 0
                        };
                        error = command.ExecuteNonQuery();
                        query = @"UPDATE [Table_Name] SET Category='Current' WHERE ((VoucherCd='C') AND (Category = ''));";


                        command = new NpgsqlCommand(query, connection)
               {
    CommandTimeout = 0
};
error = command.ExecuteNonQuery();
query = @"DROP TABLE IF EXISTS Sandbox.FinancialTools_CHPRecon_tmp_Dedup_listing;";


command = new NpgsqlCommand(query, connection)
{
    CommandTimeout = 0
};
error = command.ExecuteNonQuery();


query = @"DROP TABLE IF EXISTS Sandbox.FinancialTools_CHPRecon_DEDUP_STEP1;";


command = new NpgsqlCommand(query, connection)
{
    CommandTimeout = 0
};
error = command.ExecuteNonQuery();
query = @"DROP TABLE IF EXISTS Sandbox.FinancialTools_CHPRecon_DEDUP_STEP2;";


command = new NpgsqlCommand(query, connection)
{
    CommandTimeout = 0
};
error = command.ExecuteNonQuery();
query = @"CREATE TABLE Sandbox.FinancialTools_CHPRecon_DEDUP_STEP1 AS 
SELECT Pyt_Mon, VoucherCD, KIDS_ID, EffDate, Min(Facets_ID) AS Facets_ID_min, 
CASE
    WHEN Min(Facets_ID)=Max(Facets_ID) THEN NULL
    ELSE Max(Facets_ID) 
END 
    AS FacetsId_O, 
Min(HouseholdID) AS HOHid_min, 
CASE
    WHEN Min(HouseholdID)=Max(HouseholdID) THEN Null
    ELSE Max(HouseholdID) 
END 
    AS HOHid_O, 
Min(PaymentCat) AS PytCat_min, 
CASE 
    WHEN Min(PaymentCat)=Max(PaymentCat) THEN NULL
    ELSE Max(PaymentCat) 
END 
    AS PytCat_O, 
Min(PlanCat) AS PlnCat_min, 
CASE 
    WHEN Min(PlanCat)=Max(PlanCat) THEN NULL
    ELSE Max(PlanCat) 
END 
    AS PlnCat_O
FROM Sandbox.FinancialTools_CHPRecon_tmp_Dedup_listing
GROUP BY Pyt_Mon, VoucherCD, KIDS_ID, EffDate;";
command = new NpgsqlCommand(query, connection)
{
    CommandTimeout = 0
};
error = command.ExecuteNonQuery();
}WHEN Min(PaymentCat)=Max(PaymentCat) THEN NULL
	                                ELSE Max(PaymentCat) 
                                END 
	                                AS PytCat_O, 
                                AmtDuePlan AS AmtDue, 
                                Min(RecordNo) AS RcdNo, 
                                CASE
	                                WHEN Min(RecordNo)=Max(RecordNo) THEN Null
	                                ELSE Max(RecordNo) 
                                END
	                                AS RecordNo_O, 
                                Count(VoucherCd) AS Count, 
                                RunDate
                                FROM FinancialTools_CHPRecon_Voucher_Detail
                                GROUP BY Pyt_Mon, VoucherCD, KIDS_ID, EffDate, AmtDuePlan, RunDate
                                HAVING (((Count(VoucherCD))>1));";


                command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                error = command.ExecuteNonQuery();
                query = @"CREATE TABLE FinancialTools_CHPRecon_DEDUP_STEP2 ( Pyt_Mon, VoucherCd, KIDS_ID, EffDate, Facets_ID_min, FacetsId_O, HOHid_min, HOHid_O, PytCat_min, PytCat_O, AmtDue, RcdNo, RecordNo_O, Count, RunDate, TimeStamp ) as
                            SELECT  Pyt_Mon, VoucherCd, KIDS_ID, EffDate, Facets_ID_min, FacetsId_O, HOHid_min, HOHid_O, PytCat_min, PytCat_O, AmtDue, RcdNo, RecordNo_O, Count, RunDate, Now() AS TimeStamp
                            FROM FinancialTools_CHPRecon_DEDUP_STEP1;";


                command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                error = command.ExecuteNonQuery();
                query = @"UPDATE FinancialTools_CHPRecon_Voucher_Detail vd
                            SET DupFound = true	                    dv.ProcCd, 
	                    dv.EffDate, 
	                    dv.TermDate, 
	                    dv.Income, 
	                    dv.Employer, 
	                    dv.EmpCity, 
	                    dv.EmpState, 
	                    dv.EmpZip, 
	                    dv.EmpPhone, 
	                    dv.EmpFax, 
	                    dv.EmpEmail, 
	                    dv.EmplastUpdate, 
	                    dv.VendorName, 
	                    dv.VendorAdd1, 
	                    dv.VendorAdd2, 
	                    dv.VendorCity, 
	                    dv.VendorState, 
	                    dv.VendorZip, 
	                    dv.VendorPhone, 
	                    dv.VendorFax, 
	                    dv.VendorEmail, 
	                    dv.VendorlastUpdate, 
	                    dv.Comment, 
	                    dv.Comments, 
	                    dv.UpdateDate
                    FROM Sandbox.FinancialTools_CHPRecon_Voucher_Detail dv
                    WHERE EXISTS (
	                    SELECT 1 
	                    FROM Sandbox.FinancialTools_CHPRecon_DEDUP_STEP2 ds
	                    WHERE (dv.EffDate = ds.EffDate) 
	                    AND (dv.KIDS_ID = ds.KIDS_ID) 
	                    AND (dv.VoucherCd = ds.VoucherCd) 
                    );";

                command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                error = command.ExecuteNonQuery();                command = new NpgsqlCommand(query, connection);MOSPaid.Columns.Add("MinRunDt", typeof(DateTime));

                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };

                connection.Open();
                NpgsqlDataReader reader = command.ExecuteReader();
                if (reader.HasRows)
                {
                    while (reader.Read())
                    {
                        tblSummaryMOSPaid.Rows.Add(
                            reader["MaxPytMon"],
                            reader["MaxEffDate"],
                            reader["MaxRunDate"],
                            reader["MinPytMon"],
                            reader["MinRunDt"]
                        );
                    }
                }
                reader.Close();
                connection.Close();
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

            return tblSummaryMOSPaid;
        }
    }
}                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while(thisReader.Read())
                {
                    tblMaxDateInHistoricDetail.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1)
                        );
                }
                connection.Close();
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblMaxDateInHistoricDetail;
        }
                {
                    tblMaxDateInHistoricDup.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1)
                        );
                }
                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblMaxDateInHistoricDup;

        }(thisReader.Read())
                {
                    tblAdjSummaryByMos.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5),
                        thisReader.GetValue(6),
                        thisReader.GetValue(7),
                        thisReader.GetValue(8)
                        );
                }
                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblAdjSummaryByMos;

        }        INSERT INTO [Table1]
                                SELECT Pyt_Mon,
                                VoucherCd, 
                                EffDate, 
                                CASE
	                                WHEN AmtDuePlan = PremPayment THEN 'Retro Add'
	                                ELSE CASE
		                                WHEN AmtDuePlan = (-1)*OldPrem THEN 'Retro Term'
		                                ELSE 'Rate Adj'
	                                END
                                END AS GRP,
                                Count(VoucherCd), 
                                Sum(PremPayment), 
                                Sum(OldPrem), 
                                Sum(AmtDuePlan), 
                                RunDate
                                FROM [Table2]
                                GROUP BY Pyt_Mon, VoucherCd, EffDate, Grp, RunDate
                                HAVING VoucherCd='A'
                                ORDER BY EffDate DESC;
                                DROP TABLE IF EXISTS [Table3];
                                CREATE TABLE [Table3]
                                                    (
                                                    PytMon	Date,
                                                    VoucherCd	VARCHAR(16)	,
                                                    EffDate	DATE	,
                                                    MonTot Money	,
                                                    AddCount INTEGER,
                                                    AddAmt MONEY,
                                                    TermCount Integer,
                                                    TermAmt MONEY,
                                                    RateAdjCount IN) AS AdjCount,
                                Sum(
	                                CASE
		                                WHEN Grp ='Rate Adj' THEN TotAmtDue
		                                ELSE '$0.00'
	                                END
                                ) AS AdjAmt,
                                Sum(
	                                CASE
		                                WHEN Grp ='Voucher' THEN Count
		                                ELSE 0
	                                END
                                ) AS VchCount,
                                RunDate
                                FROM Sandbox.FinancialTools_CHPRecon_Adj_Summary
                                GROUP BY PytMon, VoucherCd, EffDate, RunDate;s.Columns.Add("TermAmt", typeof(decimal));
                tblAdjSummaryByMos.Columns.Add("RateAdjCount", typeof(int));
                tblAdjSummaryByMos.Columns.Add("AdjAmt", typeof(decimal));
                tblAdjSummaryByMos.Columns.Add("NetMM", typeof(int));
                tblAdjSummaryByMos.Columns.Add("VchCount", typeof(int));
                tblAdjSummaryByMos.Columns.Add("RunDate", typeof(DateTime));

                foreach (DataRow row in tblAdjSummaryByMos.Rows)
                {
                    // Process each row
                }s.Columns.Add("TermAmt", typeof(decimal));
                tblAdjSummaryByMos.Columns.Add("RateAdjCount", typeof(int));
                tblAdjSummaryByMos.Columns.Add("AdjAmt", typeof(decimal));
                tblAdjSummaryByMos.Columns.Add("NetMM", typeof(int));
                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblAdjSummaryByMos.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5),
                        thisReader.GetValue(6),
                        thisReader.GetValue(7),
                        thisReader.GetValue(8),
                        thisReader.GetValue(9),
                        thisReader.GetValue(10)
                        );
                }
                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblAdjSummaryByMos;

        }
        public DataTable CHPReconReportAdjSummary()
        {

            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);
            DataTable tblRptAdjSummary = new DataTable();

            try
            {

                string query = @"DROP TABLE IF EXISTS Sandbox.FinancialTools_CHPRecon_Rpt_Adj_Summary;
                                CREATE TABLE Sandbox.FinancialTools_CHPRecon_Rpt_Adj_Summary AS
                                SELECT Pyt_Mon AS PytMon, VoucherCd, Count(VoucherCd) AS TotMM, Sum(AmtDuePlan) AS TotAmtDue
                                FROM Sandbox.FinancialTools_CHPRecon_Voucher_Detail
                                GROUP BY Pyt_Mon, VoucherCd
                                HAVING VoucherCd='A';
                                SELECT * FROM  Sandbox.FinancialTools_CHPRecon_Rpt_Adj_Summary
                                GROUP BY PytMon, VoucherCd,TotMM,TotAmtDue;";



                tblRptAdjSummary.Columns.Add("PytMon", typeof(DateTime));
                tblRptAdjSummary.Columns.Add("VoucherCD", typeof(string));
                tblRptAdjSummary.Columns.Add("TotMM", typeof(int));
                tblRptAdjSummary.Columns.Add("TotAmtDue", typeof(decimal));
                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblRptAdjSummary.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3)
                        );
                }
                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();peof(string));
                tblRptSummaryForCurrentMM.Columns.Add("Prem_min", typeof(decimal));
                tblRptSummaryForCurrentMM.Columns.Add("Prem_o", typeof(decimal));
                tblRptSummaryForCurrentMM.Columns.Add("MM", typeof(int));
                tblRptSummaryForCurrentMM.Columns.Add("Amount", typeof(decimal));
                tblRptSummaryForCurrentMM.Columns.Add("EffDate", typeof(DateTime));
                tblRptSummaryForCurrentMM.Columns.Add("RunDate", typeof(DateTime));

                NpgsqlCommand command = new NpgsqlCommand(query, connection);
                connection.Open();
                NpgsqlDataAdapter da = new NpgsqlDataAdapter(command);
                da.Fill(tblRptSummaryForCurrentMM);
            }
            catch (Exception ex)
            {
                throw ex;
            }
            finally
            {
                connection.Close();
            }
            return tblRptSummaryForCurrentMM;
        }
    }
}ection();
            DataTable tblRptSummaryForCurrentMM = new DataTable();
            string query = @"SELECT * FROM table_name";
            try
            {
                tblRptSummaryForCurrentMM.Columns.Add("ID", typeof(int));
                tblRptSummaryForCurrentMM.Columns.Add("Policy", typeof(string));
                tblRptSummaryForCurrentMM.Columns.Add("Prem_Min", typeof(decimal));
                tblRptSummaryForCurrentMM.Columns.Add("Prem_O", typeof(decimal));
                tblRptSummaryForCurrentMM.Columns.Add("MM", typeof(int));
                tblRptSummaryForCurrentMM.Columns.Add("Amount", typeof(decimal));
                tblRptSummaryForCurrentMM.Columns.Add("EffDate", typeof(DateTime));
                tblRptSummaryForCurrentMM.Columns.Add("RunDate", typeof(DateTime));
                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblRptSummaryForCurrentMM.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5),
                        thisReader.GetValue(6),
                        thisReader.GetValue(7),
                        thisReader.GetValue(8)
                        );
                }
                connection.Close();
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptSummaryForCurrentMM;
        }ection();
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error: " + ex.Message);
            }d())
                {
                    DataRow row = tblRptMon.NewRow();
                    row["PytMon"] = thisReader.GetDateTime(0);
                    row["VoucherCD"] = thisReader.GetString(1);
                    row["TotMM"] = thisReader.GetInt32(2);
                    row["TotAmt"] = thisReader.GetDecimal(3);
                    tblRptMon.Rows.Add(row);
                }
                thisReader.Close();
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptMon;
        }
    }
}ER BY VoucherCd DESC;";
                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection);
                NpgsqlDataReader thisReader = command.ExecuteReader();

                tblRptMonSummary.Columns.Add("PytMon", typeof(string));
                tblRptMonSummary.Columns.Add("VoucherCd", typeof(string));
                tblRptMonSummary.Columns.Add("TotMM", typeof(decimal));
                tblRptMonSummary.Columns.Add("TotAmt", typeof(decimal));
                tblRptMonSummary.Columns.Add("AdjFr", typeof(DateTime));
                tblRptMonSummary.Columns.Add("AdjTo", typeof(DateTime));

                while (thisReader.Read())
                {
                    tblRptMonSummary.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5)
                        );
                }
                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptMonSummary;

        }g query = "SELECT * FROM table WHERE VoucherFileName = @VoucherFileName";
                NpgsqlCommand command = new NpgsqlCommand(query, connection);
                command.Parameters.AddWithValue("@VoucherFileName", VoucherFileName);
                connection.Open();
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    // Process data
                }
                connection.Close();
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
        }ry();

                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }                if (connection != null)
                    connection.Close();
            }

        }
        public void CHPReconAppendVchrDettoCummHist()
        {



            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);




            try
            {
                string query = @"INSERT INTO [table_name] ( [column_list] )
                                SELECT [column_list]
                                FROM [table_name];";

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                int error = command.ExecuteNonQuery();

                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }if (connection != null)
                    connection.Close();
            }

        }
        public void CHPReconAppendDupRecToHist()
        {



            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);




            try
            {
                string query = @"INSERT INTO sandbox.financialtools_chprecon_historic_voucher_dup ( KIDS_ID, Facets_ID, HouseholdID, RecordNo, VoucherCd, PaymentMonth, PlanID, CountyCd, EthnicityCd, FamilySize, CHPA, CHPB, PaymentCat, PremPayment, OldPrem, AmtDuePlan, AdjEffective, EffDate, RunDt, RunDate, Category, Comments, DupFound, TimeStamp, voucher_file_name )
                                SELECT KIDS_ID, Facets_ID, HouseholdID, RecordNo, VoucherCd, PaymentMonth, PlanID, CountyCd, EthnicityCd, FamilySize, CHPA, CHPB, PaymentCat, PremPayment, OldPrem, AmtDuePlan, AdjEffective, EffDate, RunDt, RunDate, Category, Comments, DupFound, TimeStamp, voucher_file_name
                                FROM sandbox.financialtools_chprecon_tmp_detail_voucher_dup;";

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                int error = command.ExecuteNonQuery();

                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }
        public void CHPReconReportPaidSummary()
        {



            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);




            try
            {
                string query = @"DROP TABLE IF EXISTS sandbox.financialtools_chprecon_rpt_paid_summary;
                                    create table  sandbox.financialtools_chprecon_rpt_paid_summary as
                                    SELECT EffDate, Sum(NetMM) AS PaidMM, Sum(MonTot) AS CapTot, 
                                    CASE 
	                                    WHEN Sum(NetMM::TEXT::MONEY) =  '0.00' THEN Sum(MonTot)
	                                    ELSE Sum(MonTot)/Sum(NetMM)
                                    END AS AvgCap
                                    FROM sandbox.financialtools_chprecon_summary_mos_paid
                                    GROUP BY EffDate
                                    HAVING (EffDate>'1/1/2015');";

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                int error = command.ExecuteNonQuery();

                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }
        public void CHPReconReportPaidMMMOSbyPytMon()
        {



            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);




            try
            {
                string query = @"DROP TABLE IF EXISTS sandbox.financialtools_chprecon_rpt_Upaid_MM_MOS_by_PytMon;
                                create table  sandbox.financialtools_chprecon_rpt_Upaid_MM_MOS_by_PytMon as
                                SELECT MOS, Max(PytMon) AS MaxOfPytMon, Min(PytMon) AS MinOfPytMon
                                FROM sandbox.financicatch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
        }
        public void CHPReconReportUnpaidMMbyMOS()
        {
            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);
            try
            {
                string query = @"DROP TABLE IF EXISTS sandbox.financialtools_chprecon_rpt_Unpaid_MM_by_MOS;
                                create table  sandbox.financialtools_chprecon_rpt_Unpaid_MM_by_MOS as
                                SELECT us.MOS, us.MbrCnt, us.PytMon
                                FROM sandbox.financialtools_chprecon_list_unpaid_summary us 
                                INNER JOIN sandbox.financialtools_chprecon_rpt_Upaid_MM_MOS_by_PytMon um 
                                ON (us.PytMon = um.MaxOfPytMon) 
                                AND (us.MOS = um.MOS)
                                ORDER BY us.MOS;";

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                int error = command.ExecuteNonQuery();
                connection.Close();
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
        }catch (NpgsqlException e)
{
if (connection != null)
connection.Close();
throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

}
finally
{
if (connection != null)
connection.Close();
}

}


public void CHPReconReportPrepSummarybyMos()
{

NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);

try
{
string query = @"DROP TABLE IF EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos;
create table  sandbox.financialtools_chprecon_rpt_prep_summary_by_mos as " +
"SELECT ps.EffDate AS 'Month Of Service',"+
"ps.PaidMM AS 'Paid Member Count',"+ 
"ps.CapTot AS 'Capitation Collected', "+
"ps.AvgCap AS 'Average PMPM', " +
"PaidMM + MbrCnt AS 'Total Plan Membership',  " +
"um.MbrCnt AS 'Unpaid Membership',  " +
"MbrCnt* AvgCap AS 'Estimated Unpaid Capitation',  " +
@"CASE 
WHEN(PaidMM::float8 + MbrCnt::float8) <> 0 THEN PaidMM::float8 / (PaidMM::float8 + MbrCnt::float8)
ELSE 0.00
END " +
"  AS 'Collection Ratio' " +
"FROM sandbox.financialtools_chprecon_rpt_paid_summary ps " +
"LEFT JOIN sandbox.financialtools_chprecon_rpt_Unpaid_MM_by_MOS um " +
"ON ps.EffDate = um.MOS " +
"ORDER BY ps.EffDate;";

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                int error = command.ExecuteNonQuery();

                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }
        public DataTable CHPReconReportSummarybyMos()
        {



            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);
            DataTable tblRptPrepSummarybyMos = new DataTable();



            try
            {
                string query = @"DROP TABLE IF EXISTS sandbox.financialtools_chprecon_rpt_summary_by_mos;
                                create table  sandbox.financialtools_chprecon_rpt_summary_by_mos as " +
                                "SELECT sm.\"Month Of Service\", " +
                                "sm.\"Paid Member Count\", " +
                                "sm.\"Capitation Collected\", " +
                                "sm.\"Average PMPM\", " +
                                "sm.\"Total Plan Membership\", " +
                                "sm.\"Unpaid Membership\", " +
                                "sm.\"Estimated Unpaid Capitation\", " +
                                "sm.\"Collection Ratio\" " +
                                "FROM sandbox.financialtools_chprecon_rpt_prep_summary_by_mos sm, sandbox.financialtools_chprecon_list_rpt_mon lm" +
                                " WHERE(((sm.\"Month Of Service\") > pytmon - interval '25 month'));" +
                                "SELECT * FROM  sandbox.fin.                }
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
        }
    }
} = 0
                };
                command.ExecuteNonQuery();
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
        }
    }
}= td.\"Month Of Service\" AND Seq = 3; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Capitation Earned\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 4; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Total Medical Expense\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 5; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Total Pharmacy Expense\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 6; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Total Utilization Expense\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 7; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Total Capitation Expense\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 8; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Total Reinsurance Expense\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 9; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Total Cost Of Care\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 10; " +

                            "UPDATE sandbox.financialtools_chprecon_tmpRpt_CurMon " +
                            "SET Entry = td.\"Total Cost Of Care PMPM\" " +
                            "FROM sandbox.financialtools_chprecon_tmp_Data_CurMon td " +
                            "WHERE MOS = td.\"Month Of Service\" AND Seq = 11;";


                NpgsqlCommand command = new NpgsqlCommand(query, connection);

                connection.Open();

                int error = command.ExecuteNonQuery();

                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }}if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }
        public void CHPReconPrepAppendMonList()
        {



            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);




            try
            {
                string query = @"DELETE FROM sandbox.financialtools_chprecon_tmp_MOS_List; "+
                " INSERT INTO sandbox.financialtools_chprecon_tmp_MOS_List ( \"Month Of Service\", PytMon, AgeMon ) " +
                " SELECT rp.\"Month Of Service\", lr.PytMon, (DATE_PART('year', lr.PytMon) - DATE_PART('year', rp.\"Month Of Service\")) * 12 + DATE_PART('month', lr.PytMon) - DATE_PART('month', rp.\"Month Of Service\") AS AgeMon "+
                " FROM sandbox.financialtools_chprecon_rpt_prep_summary_by_mos rp, " +
                " sandbox.financialtools_chprecon_list_rpt_mon lr " +
                " GROUP BY rp.\"Month Of Service\", lr.PytMon,agemon "+
                " HAVING((DATE_PART('year', lr.PytMon) - DATE_PART('year', rp.\"Month Of Service\")) * 12 + DATE_PART('month', lr.PytMon) - DATE_PART('month', rp.\"Month Of Service\") < 25) "+
                " ORDER BY agemon DESC; " +
                " UPDATE sandbox.financialtools_chprecon_tmp_MOS_List  SET Grp=AgeMon/6+0.51, Timestamp = now()";

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                int error = command.ExecuteNonQuery();

                connection.Close();

            }

            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
            } (NpgsqlException e)
            {
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }DataTable CHPReconReportSummaryBy6Ms()
        {

            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);
            DataTable tblRptSummaryBy6Ms = new DataTable();

            try
            {

                string query = @"SELECT 
	                                CASE
		                                WHEN MOS_fr=MOS_to THEN to_char(MOS_fr,'mm/yyyy')
		                                ELSE to_char(MOS_fr,'mm/yyyy')||' - '|| to_char(MOS_to,'mm/yyyy')
	                                END AS MOS_range, 
                                PaidMM," + 
                                "Cap AS \"Cap Colletted\", " +
                                @"CASE
                                     WHEN PaidMM = '0.00' THEN '0.00'
                                     ELSE Cap / PaidMM 
                                  END AS AvgPMPM,
                                  Tot_MM,
                                  UnpaidMM,
                                  EstUnpaid, " +
                                  "paidMM/ Tot_MM AS \"Collection Ratio\" " +
                                @"FROM sandbox.financialtools_chprecon_Rpt_prep_Summ_by_6m
                                ORDER BY Grp DESC; ";

                tblRptSummaryBy6Ms.Columns.Add("MosRange", typeof(string));
                tblRptSummaryBy6Ms.Columns.Add("PaidMM", typeof(int));
                tblRptSummaryBy6Ms.Columns.Add("CapCollected", typeof(decimal));
                tblRptSummaryBy6Ms.Columns.Add("AvgPMPM", typeof(decimal));
                tblRptSummaryBy6Ms.Columns.Add("To```csharp
t_MM", typeof(int));
                tblRptSummaryBy6Ms.Columns.Add("UnpaidMM", typeof(int));
                tblRptSummaryBy6Ms.Columns.Add("EstUnpaid", typeof(decimal));
                tblRptSummaryBy6Ms.Columns.Add("CollectionRation", typeof(double));
                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblRptSummaryBy6Ms.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5),
                        thisReader.GetValue(6),
                        thisReader.GetValue(7)
                        );
                }
                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptSummaryBy6Ms;

        }
        public DataTable CHPReconReportSummaryCurrentMonth()
        {

            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);
            DataTable tblRptSummaryCurrentMonth = new DataTable();

            try
            {

                string query = @"SELECT MOS, ReportList, Entry
                                FROM sandbox.financialtools_chprecon_tmpRpt_CurMon";
```
                    " TotMMVchr AS \"Voucher Month Count\", " +
                    " ROUND(TotMMVchr/TotMM*100, 2) AS \"Voucher %\", " +
                    " TotMMVchr - TotMM AS \"Count Diff\" " +
                    " FROM " +
                    " ORDER BY Seq;";

                tblRptVoucherSummary.Columns.Add("Payment Month", typeof(string));
                tblRptVoucherSummary.Columns.Add("Voucher Code", typeof(string));
                tblRptVoucherSummary.Columns.Add("Member Month Count", typeof(string));
                tblRptVoucherSummary.Columns.Add("Voucher Month Count", typeof(string));
                tblRptVoucherSummary.Columns.Add("Voucher %", typeof(string));
                tblRptVoucherSummary.Columns.Add("Count Diff", typeof(string));

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblRptVoucherSummary.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5)
                        );
                }
                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptVoucherSummary;

        }DataTable tblRptUnpaidSummaryByMOS = new DataTable();

            tblRptUnpaidSummaryByMOS.Columns.Add("Payment Month", typeof(DateTime));
            tblRptUnpaidSummaryByMOS.Columns.Add("Month of Service", typeof(string));
            tblRptUnpaidSummaryByMOS.Columns.Add("Member Count", typeof(int));

            NpgsqlConnection connection = new NpgsqlConnection(ConnectionString);

            try
            {
                string query = @"Select  pytmon, mos, sum(mbrcnt) FROM sandb";

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblRptUnpaidSummaryByMOS.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2)
                        );
                }
                connection.Close();
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptUnpaidSummaryByMOS;
        }ox.financialtools_CHPRecon_List_Unpaid_Summary group by mos, pytmon ORDER BY MOS, PytMon DESC;";

                tblPrepRptUnpaidSummaryByMOS.Columns.Add("PytMon", typeof(DateTime));

                tblPrepRptUnpaidSummaryByMOS.Columns.Add("Mos", typeof(DateTime));
                tblPrepRptUnpaidSummaryByMOS.Columns.Add("MbrCnt", typeof(int));


                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblPrepRptUnpaidSummaryByMOS.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2)
                        );
                }
                var data2 = tblPrepRptUnpaidSummaryByMOS.AsEnumerable().Select(x => new {
                    Mos = x.Field<DateTime>("Mos"),
                    PytMon = x.Field<DateTime>("PytMon"),
                    MbrCnt = x.Field<int>("MbrCnt")
                });
                tblRptUnpaidSummaryByMOS = data2.ToPivotTable(
                   item => item.PytMon,
                   item => item.Mos,
                   items => items.Any() ? items.Sum(x => x.MbrCnt) : 0);
                DateTime[] names = new DateTime[tblRptUnpaidSummaryByMOS.Columns.Count - 1];
                for (int i = 0; i < tblRptUnpaidSummaryByMOS.Columns.Count - 1; i++)
                {
                    names[i] = DateTime.Parse(tblRptUnpaidSummaryByMOS.Columns[i + 1].ColumnName, CultureInfo.InvariantCulture);
                }

                Array.Sort(names);
                for (int i = 0; i < tblRptUnpaidSummaryByMOS.Columns.Count - 1; i++)
                {

                    var col = tblRptUnpaidSummaryByMOS.Columns[names[i]];
                }                        thisReader.GetValue(1),
                        thisReader.GetValue(2)
                    );
                }

                thisReader.Close();

                tblRptMbrByMOS = tblPrepRptMbrByMOS.Clone();

                for (int i = 0; i < tblPrepRptMbrByMOS.Columns.Count; i++)
                {
                    DataColumn col = tblPrepRptMbrByMOS.Columns[i];
                    tblRptMbrByMOS.Columns[i].DataType = col.DataType;
                    tblRptMbrByMOS.Columns[i].ColumnName = col.ColumnName;
                    tblRptMbrByMOS.Columns[i].SetOrdinal(i);
                }

                foreach (DataRow row in tblPrepRptMbrByMOS.Rows)
                {
                    tblRptMbrByMOS.ImportRow(row);
                }

                for (int i = 0; i < tblRptMbrByMOS.Columns.Count; i++)
                {
                    DataColumn col = tblRptMbrByMOS.Columns[i];
                    col.SetOrdinal(i + 1);
                }

                connection.Close();


            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptMbrByMOS;

        }thisReader.GetValue(1),
                        thisReader.GetValue(2)
                        );
                }
                var data2 = tblPrepRptMbrByMOS.AsEnumerable().Select(x => new {
                    Mos = x.Field<DateTime>("Mos"),
                    PytMon = x.Field<DateTime>("PytMon"),
                    NetMM = x.Field<int>("NetMM")
                });
                tblRptMbrByMOS = data2.ToPivotTable(
                   item => item.PytMon,
                   item => item.Mos,
                   items => items.Any() ? items.Sum(x => x.NetMM) : 0);

                var col = tblRptMbrByMOS.Columns.Add("MbrMon", typeof(int));
                col.SetOrdinal(1);
                DateTime[] names = new DateTime[tblRptMbrByMOS.Columns.Count-2];
                for (int i = 0; i < tblRptMbrByMOS.Columns.Count-2; i++)
                {
                    names[i] = DateTime.Parse(tblRptMbrByMOS.Columns[i+2].ColumnName,CultureInfo.InvariantCulture);
                }
                
                Array.Sort(names);
                for (int i = 0; i < tblRptMbrByMOS.Columns.Count - 2; i++)
                {

                    col = tblRptMbrByMOS.Columns[names[i].ToString()];
                    col.SetOrdinal(i+2);
                }
                
                connection.Close();
                foreach (DataRow row in tblRptMbrByMOS.Rows)
                {
                    int rowSum = 0;
                    foreach (DataColumn col1 in row.Table.Columns)
                    {
                        if ((!row.IsNull(col1))&&(col1.Ordinal>1))
                        {
                            string stringValue = row[col1].ToString();
                            int d;
                            if (int.TryParse(stringValue, out d))
                                rowSum += d;
                        }
                    }
                    row.SetField("MbrMon", rowSum);
          e(2)
                    );
                }
                tblRptPytAmtbyMOS = tblPrepRptPytAmtbyMOS.Copy();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblRptPytAmtbyMOS;

        }
                );
        }
        var data2 = tblPrepRptPytAmtbyMOS.AsEnumerable().Select(x => new {
            Mos = x.Field<DateTime>("Mos"),
            PytMon = x.Field<DateTime>("PytMon"),
            Cap = x.Field<int>("Cap")
        });
        tblRptPytAmtbyMOS = data2.ToPivotTable(
           item => item.PytMon,
           item => item.Mos,
           items => items.Any() ? items.Sum(x => x.Cap) : 0);

        var col = tblRptPytAmtbyMOS.Columns.Add("CapTot", typeof(int));
        col.SetOrdinal(1);
        DateTime[] names = new DateTime[tblRptPytAmtbyMOS.Columns.Count - 2];
        for (int i = 0; i < tblRptPytAmtbyMOS.Columns.Count - 2; i++)
        {
            names[i] = DateTime.Parse(tblRptPytAmtbyMOS.Columns[i + 2].ColumnName, CultureInfo.InvariantCulture);
        }

        Array.Sort(names);
        for (int i = 0; i < tblRptPytAmtbyMOS.Columns.Count - 2; i++)
        {

            col = tblRptPytAmtbyMOS.Columns[names[i].ToString()];
            col.SetOrdinal(i + 2);
        }
        connection.Close();
        foreach (DataRow row in tblRptPytAmtbyMOS.Rows)
        {
            int rowSum = 0;
            foreach (DataColumn col1 in row.Table.Columns)
            {
                if ((!row.IsNull(col1)) && (col1.Ordinal > 1))
                {
                    string stringValue = row[col1].ToString();
                    int d;
                    if (int.TryParse(stringValue, out d))
                        rowSum += d;
                }
            }
            row.SetField("CapTot", rowSum);
        }


    }
    catch (NpgsqlException e)dd("pytcat_min", typeof(string));
                tblTmpDedupListing.Columns.Add("pytcat_o", typeof(string));
                tblTmpDedupListing.Columns.Add("amtdue", typeof(decimal));
                tblTmpDedupListing.Columns.Add("rcdno", typeof(string));
                tblTmpDedupListing.Columns.Add("recordno_o", typeof(string));
                tblTmpDedupListing.Columns.Add("count", typeof(int));
                tblTmpDedupListing.Columns.Add("rundate", typeof(DateTime));

                NpgsqlDataAdapter adapter = new NpgsqlDataAdapter(query, connection);
                adapter.Fill(tblTmpDedupListing);
            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblTmpDedupListing;

        }
    }
}dd("pytcat_min", typeof(string));
                tblTmpDedupListing.Columns.Add("pytcat_o", typeof(string));
                tblTmpDedupListing.Columns.Add("amtdue", typeof(decimal));
                tblTmpDedupListing.Columns.Add("rcdno", typeof(string));
                tblTmpDedupListing.Columns.Add("recordno_o", typeof(string));
                tblTmpDedupListing.Columns.Add("count", typeof(int));
                tblTmpDedupListing.Columns.Add("rundate", typeof(DateTime));

                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                NpgsqlDataReader thisReader = command.ExecuteReader();
                while (thisReader.Read())
                {
                    tblTmpDedupListing.Rows.Add(
                        thisReader.GetValue(0),
                        thisReader.GetValue(1),
                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5),
                        thisReader.GetValue(6),
                        thisReader.GetValue(7),
                        thisReader.GetValue(8),
                        thisReader.GetValue(9),
                        thisReader.GetValue(10),
                        thisReader.GetValue(11),
                         thisReader.GetValue(12),
                        thisReader.GetValue(13),
                        thisReader.GetValue(14)
                        );
                }
 
                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);
            }
            finallyAdd("paymentmonth", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("pyt_mon", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("planid", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("countycd", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("ethnicitycd", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("familysize", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("chpa", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("chpb", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("paymentcat", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("prempayment", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("oldprem", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("amtdueplan", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("adjeffective", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("effdate", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("rundt", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("rundate", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("comments", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("dupfound", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("category", typeof(string));
                tblTmpDetailVoucherDup.Columns.Add("timestamp", typeof(string));

                connection.Open();

                NpgsqlCommand command = new NpgsqlCommand(query, connection);
                NpgsqlDataAdapter adapter = new NpgsqlDataAdapter(command);
                adapter.Fill(tblTmpDetailVoucherDup);

            }
            catch (Exception ex)
            {
                Console.WriteLine("Error: " + ex.Message);
            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }
            return tblTmpDetailVoucherDup;
        }
    }
}                        thisReader.GetValue(2),
                        thisReader.GetValue(3),
                        thisReader.GetValue(4),
                        thisReader.GetValue(5),
                        thisReader.GetValue(6),
                        thisReader.GetValue(7),
                        thisReader.GetValue(8),
                        thisReader.GetValue(9),
                        thisReader.GetValue(10),
                        thisReader.GetValue(11),
                        thisReader.GetValue(12),
                        thisReader.GetValue(13),
                        thisReader.GetValue(14),
                        thisReader.GetValue(15),
                        thisReader.GetValue(16),
                        thisReader.GetValue(17)
                    );
                }
                thisReader.Close();
                connection.Close();
.financialtools_chprecon_rpt_prep_detail_by_mos;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec_a ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec_a ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec_a_psec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec_a_psec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec_a_psec_fsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_detail_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec_a_psec_fsec ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summary_by_mos_fy_qtr_month_wk_day_hr_min_sec_msec_usec_nsec_psec_fsec_a_nsec_psec_fsec_a_psec_fsec_a ;
                    DROP TABLE If EXISTS sandbox.fin.financialtools_chprecon_tmprpt_curmon ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_tmp_data_curmon ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_dedup_step3 ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_list_rpt_mon ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_voucher_detail ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_dedup_step1 ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_dedup_step2 ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_summary_by_adj_type_mos ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_adj_summary_by_mos ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_adj_summary ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_summary_for_current_mm ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_summary_cur ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_monrpt_summary ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_monrptsummary ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_paid_summary ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_upaid_mm_mos_by_pytmon ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_unpaid_mm_by_mos ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_summary_by_mos ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_rpt_prep_summ_by_6m ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_monrpt ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_tmp_detail_voucher_dup ;
                    DROP TABLE If EXISTS sandbox.financialtools_chprecon_tmp_mos_list;
                                GrossMM INTEGER,
                                VoucherCnt INTEGER,
                                TrxDate DATE,
                                TrxType VARCHAR(16),
                                TrxDesc VARCHAR(50),
                                VendorCd VARCHAR(16),
                                VendorName VARCHAR(50),
                                VendorType VARCHAR(50),
                                PayeeCd VARCHAR(16),
                                PayeeName VARCHAR(50),
                                PayeeType VARCHAR(50),
                                PayeeTaxID VARCHAR(50),
                                PayeeAddr1 VARCHAR(50),
                                PayeeAddr2 VARCHAR(50),
                                PayeeCity VARCHAR(50),
                                PayeeState VARCHAR(50),
                                PayeeZip VARCHAR(50),
                                PayeeCountry VARCHAR(50),
                                PayeeEmail VARCHAR(50),
                                PayeePhone VARCHAR(50),
                                PayeeFax VARCHAR(50),
                                OrigVoucherCd VARCHAR(16),
                                OrigEffDate DATE,
                                OrigTrxDate DATE,
                                OrigTrxType VARCHAR(16),
                                OrigTrxDesc VARCHAR(50),
                                OrigMonTot Money,
                                OrigNetMM INTEGER,
                                OrigGrossMM INTEGER,
                                OrigVendorCd VARCHAR(16),
                                OrigVendorName VARCHAR(50),
                                OrigVendorType VARCHAR(50),
                                OrigPayeeCd VARCHAR(16),
                                OrigPayeeName VARCHAR(50),
                                OrigPayeeType VARCHAR(50),
                                OrigPayeeTaxID VARCHAR(50),
                                OrigPayeeAddr1 VARCHAR(50),
                                OrigPayeeAddr2 VARCHAR(50),
                                OrigPayeeCity VARCHAR(50),
                                OrigPayeeState VARCHAR(50),
                                OrigPayeeZip VARCHAR(50),
                                OrigPayeeCountry VARCHAR(50),
                                OrigPayeeEmail VARCHAR(50),
                                OrigPayeePhone VARCHAR(50),
                                OrigPayeeFax VARCHAR(50)
                                ) DISTRIBUTED BY (PytMon, VoucherCd);

                                CREATE TABLE Sandbox.FinancialTools_CHPRecon_List_Unpaid_Summary
                                (
                                VendorCd VARCHAR(16),
                                VendorName VARCHAR(50),
                                VendorType VARCHAR(50),
                                PayeeCd VARCHAR(16),
                                PayeeName VARCHAR(50),
                                PayeeType VARCHAR(50),
                                PayeeTaxID VARCHAR(50),
                                PayeeAddr1 VARCHAR(50),
                                PayeeAddr2 VARCHAR(50),
                                PayeeCity VARCHAR(50),
                                PayeeState VARCHAR(50),
                                PayeeZip VARCHAR(50),
                                PayeeCountry VARCHAR(50),
                                PayeeEmail VARCHAR(50),
                                PayeePhone VARCHAR(50),
                                PayeeFax VARCHAR(50),
                                VoucherCd VARCHAR(16),
                                EffDate DATE,
                                MonTot Money,
                                NetMM INTEGER,
                                GrossMM INTEGER,
                                VoucherCnt INTEGER
                                ) DISTRIBUTED BY (VendorCd, PayeeCd, VoucherCd);";


                connection.Open();
                NpgsqlCommand command = new NpgsqlCommand(query, connection)
                {
                    CommandTimeout = 0
                };
                int error = command.ExecuteNonQuery();

                connection.Close();

            }
            catch (NpgsqlException e)
            {
                if (connection != null)
                    connection.Close();
                throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

            }
            finally
            {
                if (connection != null)
                    connection.Close();
            }

        }AddCount INTEGER,
                                AddAmt Money,
                                TermCount INTEGER, 
                                TermAmt Money,
                                RateAdjCount INTEGER,
                                AdjAmt MONEY,
                                VchCount INTEGER,
                                RunDate TimeStamp,
                                TimeStamp TimeStamp,
                                voucher_file_name VARCHAR(255)
                                );
                            CREATE TABLE FinancialTools_CHPRecon_Historic_Voucher_Detail
                                                (
                                                vouchercd VARCHAR(16) ,
                                                pytmon VARCHAR(16) ,
                                                pyt_mon DATE ,
                                                planid VARCHAR(16) ,
                                                householdid VARCHAR(16) ,
                                                kids_id VARCHAR(16) ,
                                                countycd VARCHAR(16) ,
                                                ethnicitycd VARCHAR(16) ,
                                                familysize INTEGER ,
                                                chpa INTEGER ,
                                                chpb INTEGER ,
                                                paymentcat VARCHAR(16) ,
                                                prempayment MONEY ,
                                                oldprem MONEY ,
                                                amtdueplan MONEY ,
                                                adjeffective DATE ,
                                                effdate DATE ,
                                                rundt TIMESTAMP ,
                                                rundate TIMESTAMP ,recordno VARCHAR(16),
                                                facets_id VARCHAR(16),
                                                category VARCHAR(255),
                                                comments VARCHAR(255),
                                                dupfound BOOL,
                                                timestamp TimeStamp,
                                                voucher_file_name VARCHAR(255)
                                                );
                            CREATE TABLE FinancialTools_CHPRecon_Historic_Voucher_Dup
                                                        ( KIDS_ID VARCHAR(16), 
                                                        RecordNo VARCHAR(16), 
                                                        Facets_ID VARCHAR(16), 
                                                        HouseholdID VARCHAR(16), 
                                                        VoucherCd VARCHAR(16), 
                                                        PaymentMonth VARCHAR(16), 
                                                        Pyt_Mon DATE, 
                                                        PlanID VARCHAR(16), 
                                                        CountyCd VARCHAR(16), 
                                                        EthnicityCd VARCHAR(16), 
                                                        FamilySize INTEGER, 
                                                        CHPA INTEGER, 
                                                        CHPB INTEGER, 
                                                        PaymentCat VARCHAR(16), 
                                                        PremPayment MONEY, 
                                                        OldPrem MONEY, 
                                                        AmtDuePlan MONEY,```csharp
AdjEffective DATE, 
EffDate Date, 
RunDt Timestamp, 
RunDate Timestamp, 
Comments VARCHAR(255), 
DupFound BOOL, 
Category VARCHAR(255), 
TimeStamp Timestamp,
voucher_file_name VARCHAR(255));

CREATE TABLE FinancialTools_CHPRecon_List_Unpaid_Summary
(PytMon DATE,
CreateDate DATE,
Mos DATE,
MbrCnt integer,
Comment VARCHAR(255),
TIMESTAMP TIMESTAMP,
voucher_file_name VARCHAR(255));";

connection.Open();
NpgsqlCommand command = new NpgsqlCommand(query, connection)
{
    CommandTimeout = 0
};
int error = command.ExecuteNonQuery();

connection.Close();

}
catch (NpgsqlException e)
{
    if (connection != null)
        connection.Close();
    throw new NpgsqlException(@"Greenplum database error: " + e.ToString(), e);

}
finally
{
    if (connection != null)
        connection.Close();
}

}
```